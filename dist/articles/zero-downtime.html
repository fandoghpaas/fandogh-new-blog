<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Zero Downtime Deployment | پلتفرم فندق</title>
    <meta name="description" content="در این پست به تشریح فرایند استقرار نسخه‌های جدید یک سرویس بر روی فندق می‌پردازیم. این مطالب به شما کمک خواهد کرد تا با مفهوم Zero Downtime Deployment بیشتر آشنا شوید. همچنین برای اینکه فندق بتواند این نوع استقرار را به درستی انجام  دهد تنظیماتی از جانب کاربران مورد نیاز است که در این پست به تشریح آنها نیز خواهیم پرداخت.\n">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.1/flexboxgrid.css">
    
    <link rel="preload" href="/assets/css/0.styles.0f42652f.css" as="style"><link rel="preload" href="/assets/js/app.3d705a25.js" as="script"><link rel="preload" href="/assets/js/11.41137f57.js" as="script"><link rel="prefetch" href="/assets/js/10.7e0eddf6.js"><link rel="prefetch" href="/assets/js/12.a979cec4.js"><link rel="prefetch" href="/assets/js/13.198d2923.js"><link rel="prefetch" href="/assets/js/2.78835d9f.js"><link rel="prefetch" href="/assets/js/3.9071ab19.js"><link rel="prefetch" href="/assets/js/4.51eaa9e5.js"><link rel="prefetch" href="/assets/js/5.66f51d6c.js"><link rel="prefetch" href="/assets/js/6.50da27a0.js"><link rel="prefetch" href="/assets/js/7.12598bb5.js"><link rel="prefetch" href="/assets/js/8.ba9d2e31.js"><link rel="prefetch" href="/assets/js/9.20f5dee3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0f42652f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><header data-v-770c82b2><a href="/" data-v-770c82b2><img src="/assets/img/fandogh-logo.cef32c95.png" alt="fandogh-logo" data-v-770c82b2></a></header> <section class="section"><!----> <div class="single-content"><div class="content"><h1>Zero Downtime Deployment</h1> <div class="content custom"><p>در این پست به تشریح فرایند استقرار نسخه‌های جدید یک سرویس بر روی فندق می‌پردازیم. این مطالب به شما کمک خواهد کرد تا با مفهوم Zero Downtime Deployment بیشتر آشنا شوید. همچنین برای اینکه فندق بتواند این نوع استقرار را به درستی انجام دهد تنظیماتی از جانب کاربران مورد نیاز است که در این پست به تشریح آنها نیز خواهیم پرداخت.</p> <h2 id="چرایی-zero-downtime-deployment"><a href="#چرایی-zero-downtime-deployment" aria-hidden="true" class="header-anchor">#</a> چرایی Zero Downtime Deployment</h2> <p>یکی از مشکلاتی که در حین استقرار سرویس‌ها و وب‌ سایت‌ها ممکن است اتفاق بیفتد در دسترس نبودن سرویس برای مدتی نامعلوم است که می‌تواند منجر به از دست دادن مشتری‌ها و یا نارضایتی آنها شود.</p> <p>تفاوتی ندارد که شما به صورت انفرادی در حال توسعه محصولی کوچک هستید و یا در تیمی بزرگ بر روی محصولی سازمانی کار می‌کنید. همیشه بخشی از زمان شما و یا تیم شما برای استقرار و نگهداری سرویس‌هایتان خرج می‌شود.</p> <p>اگر این کار به صورت دستی انجام شود بخش قابل ملاحظه‌ای از زمان خود را به خود اختصاص می‌دهد و همینطور در هر یک از مراحل استقرار امکان اشتباه انسانی وجود دارد که ممکن است منجر به قطع شدن سرویس شما برای مدتی بیش از حد پیش بینی شما شود.</p> <h2 id="فندق-و-zero-downtime-deployment"><a href="#فندق-و-zero-downtime-deployment" aria-hidden="true" class="header-anchor">#</a> فندق و Zero Downtime Deployment</h2> <p>در فندق تمام مراحل استقرار نسخه جدید سرویس به صورت خودکار صورت می‌گیرد و کاربر تنها نیاز به مانیتور استقرار دارد تا مطمئن شود که نسخه جدید بدون مشکل مستقر شده است.</p> <div class="warning custom-block"><p class="custom-block-title">توجه</p> <p>حتی در صورت وجود مشکل در نسخه جدید سرویس شما از دسترس خارج نخواهد شد و نسخه قبلی سرویس شما به کاربران سرویس خواهد داد.</p></div> <p>برای اینکه فندق بتواند به صورت خودکار و بدون downtime استقرار نسخه جدید را انجام دهد نیاز به روشی برای تست سلامت سرویس شما خواهد داشت (healthcheck). با استفاده از این تست فندق قبل از خارج کردن نسخه قبلی سرویس شما می‌تواند مطمئن شود که نسخه جدید به درستی و بدون مشکل مستقر شده و آماده دسترسی به درخواست کاربران و یا دیگر سرویس‌ها است.</p> <p>در ادامه به صورت قدم به قدم به همراه مثال مراحل لازم برای ایجاد یک سرویس با قابلیت تست سلامت و نحوه عملکرد فندق را شرح خواهیم داد.</p> <p>کدهای استفاده شده در این پست را می‌توانید از
<a href="https://github.com/fandoghpaas/fandogh-examples/tree/master/zero-downtime" target="_blank" rel="noopener noreferrer">‌اینجا<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
مشاهده و دانلود کنید.</p> <h2 id="مطالعه-موردی"><a href="#مطالعه-موردی" aria-hidden="true" class="header-anchor">#</a> مطالعه موردی</h2> <p>در این مثال فرض بر این است که نسخه اول یک وب اپلیکیشن که دارای دو replica است در حال حاضر روی فندق مستقر شده است و ما قصد داریم نسخه ۱.۱ این وب اپلیکیشن را بدون از دسترس خارج شدن بر روی فندق مستقر کنیم.</p> <p>کد مربوط به نسخه اول را در
<a href="https://github.com/fandoghpaas/fandogh-examples/tree/master/zero-downtime/v1" target="_blank" rel="noopener noreferrer">اینجا<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
می‌توانید مشاهده کنید.</p> <div class="warning custom-block"><p class="custom-block-title">توجه</p> <p>توجه داشته باشید که امکان replica تنها برای پلن‌های غیر رایگان فندق قابل استفاده است. اگر کاربر پلن رایگان فندق هستید ‌شما همچنان قادر به استقرار بدون down time ولی با یک replica هستید.</p></div> <p>پس از اینکه image پروژه را بر روی فندق منتشر نمودید با استفاده از این مانیفست می‌توانید سرویس نسخه اول را مستقر نمایید.</p> <p>‍</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> ExternalService
<span class="token key atrule">name</span><span class="token punctuation">:</span> zero<span class="token punctuation">-</span>downtime
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> zero<span class="token punctuation">-</span>downtime<span class="token punctuation">:</span>v1.0
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">readiness_probe</span><span class="token punctuation">:</span>
    <span class="token key atrule">http_get</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">initial_delay_seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">period_seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
</code></pre></div><p>شما می‌توانید این فایل را از
<a href="https://github.com/fandoghpaas/fandogh-examples/blob/master/zero-downtime/service-manifest.yml" target="_blank" rel="noopener noreferrer">اینجا<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
دانلود نمایید.</p> <p>اگر با مانیفست‌ها در فندق آشنایی ندارید می‌توانید جزییات و نحوه استفاده از آنها در فندق را در
<a href="https://docs.fandogh.cloud/docs/service-manifest.html" target="_blank" rel="noopener noreferrer">اینجا<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
مطالعه کنید.</p> <p>پس از ایجاد فایل مانیفست با استفاده از دستور زیر می‌توانید سرویس را بر روی فندق مستقر نمایید.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>fandogh <span class="token function">service</span> apply -f service-manifest.yml
</code></pre></div><p>خروجی این دستور URL هایی خواهد بود که وب سایت شما از طریق آنها قابل دسترسی است.</p> <p>تا به اینجای کار دیاگرام کلی سرویس شما بر روی فندق، به شکل زیر خواهد بود. البته توجه داشته باشید که بخش زیاد از جزییات که مرتبط با موضوع این پست نبوده‌اند از این دیاگرام حذف شده‌اند.</p> <p><img src="/articles/zero-downtime1.png" alt="Zero Downtime Deployment step 1" title="Zero Downtime Deployment step 1"></p> <p>همانطور که در تصویر نیز مشاهده می‌کنید در مقابل replica های سرویس مستقر شده بر روی فندق یک load balancer داخلی اختصاصی ایجاد شده که وظیفه‌اش پخش درخواست‌ها به replica های آماده به پاسخگویی است.</p> <h3 id="استقرار-نسخه-جدید-سرویس"><a href="#استقرار-نسخه-جدید-سرویس" aria-hidden="true" class="header-anchor">#</a> استقرار نسخه جدید سرویس</h3> <p>در این مرحله قصد داریم نسخه جدید سرویس را بر روی فندق مستقر کنیم. کد مربوط به این نسخه را می‌توانید
<a href="https://github.com/fandoghpaas/fandogh-examples/tree/master/zero-downtime/v1.1" target="_blank" rel="noopener noreferrer">اینحا<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
مشاهده نمایید.</p> <p>بعد از اینکه این نسخه از ایمیج را منتشر کردید با استفاده از این مانیفست میتونید نسخه جدید سرویس را منتشر کنید:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">kind</span><span class="token punctuation">:</span> ExternalService
<span class="token key atrule">name</span><span class="token punctuation">:</span> zero<span class="token punctuation">-</span>downtime
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> zero<span class="token punctuation">-</span>downtime<span class="token punctuation">:</span>v1.1
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">readiness_probe</span><span class="token punctuation">:</span>
    <span class="token key atrule">http_get</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">initial_delay_seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">period_seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
</code></pre></div><p>بعد از apply کردن این مراحل بر روی فندق اتفاق خواهد افتاد</p> <h3 id="ایجاد-یک-replica-از-سرویس"><a href="#ایجاد-یک-replica-از-سرویس" aria-hidden="true" class="header-anchor">#</a> ایجاد یک replica از سرویس</h3> <p>همانطور که در دیاگرام زیر نیز مشاهده می‌کنید در این مرحله یک replica با نسخه جدید ایمیج شما بر روی فندق ایجاد خواهد شد. در این مرحله هنوز ترافیکی توسط load balancer به این سرویس ارسال نمی‌شود و تنها تست آمادگی سرویس جدید فراخوانی می‌شود. مادامی که تست آمادگی این replica که فراخوانی یک http endpoint است چیزی به غیر از http code ۲۰۰ باشد سرویس در این وضعیت می‌ماند.</p> <p><img src="/articles/zero-downtime2.png" alt="Zero Downtime Deployment step 2" title="Zero Downtime Deployment step 2"></p> <h3 id="پاسخ-مثبت-به-تست-آمادگی"><a href="#پاسخ-مثبت-به-تست-آمادگی" aria-hidden="true" class="header-anchor">#</a> پاسخ مثبت به تست آمادگی</h3> <p>پس از اینکه فراخوانی تست آمادگی پاسخ دریافت کرد این نسخه از replica شروع به دریافت ترافیک از load balancer خواهد کرد. همچنین در این لحظه به دلیل اینکه تعداد replica های سرویس شما بیش از تعدادی است که در مانیفست توصیف کرده اید فرایند حذف یکی از نسخه‌های قدیمی سرویس شما از فندق آغاز می‌گردد.</p> <p>فرایند حذف شامل این مراحل است:</p> <ul><li>لود بالانسر درخواست جدید به این replica ارسال نمی‌کند</li> <li>لود بالانسر صبر می‌کند تا تمام درخواست‌های ارسال شده به سرویس پاسخ داده شده و یا timeout شوند</li> <li>بعد از این دو مرحله replica حذف شده و منابع اختصاص داده شده به آن آزاد می‌شوند</li></ul> <p><img src="/articles/zero-downtime3.png" alt="Zero Downtime Deployment step 3" title="Zero Downtime Deployment step 3"></p> <h3 id="تکرار-مراحل-فوق-تا-به-روز-شدن-تمام-replica-ها"><a href="#تکرار-مراحل-فوق-تا-به-روز-شدن-تمام-replica-ها" aria-hidden="true" class="header-anchor">#</a> تکرار مراحل فوق تا به روز شدن تمام replica ها</h3> <p>مراحلی که در بالا تشریح شدند دوباره تکرار خواهند شد تا تمام replica های سرویس مورد نظر به روز شوند.
در دیاگرام‌هایی که در ادامه آمده اند این مراحل ترسیم شده‌اند.</p> <p><img src="/articles/zero-downtime4.png" alt="Zero Downtime Deployment step 4" title="Zero Downtime Deployment step 4"></p> <p>پس از اینکه replica با نسخه جدید آماده شد لودبالانسر شروع بر ارسال بخشی از ترافیک به این replica می‌کنید و به طور همزمان فرایند مورد نیاز برای حذف replica با نسخه قبلی آغاز می‌شود.</p> <p><img src="/articles/zero-downtime5.png" alt="Zero Downtime Deployment step 5" title="Zero Downtime Deployment step 5"></p> <p>بعد از اینکه تمام درخواست‌هایی که به replica قدیمی پاسخ داده شده‌اند این replica حذف شده و منابع اختصاص داده شده به آن آزاد می‌شود</p> <p><img src="/articles/zero-downtime6.png" alt="Zero Downtime Deployment step 6" title="Zero Downtime Deployment step 6"></p> <h2 id="چند-نکته"><a href="#چند-نکته" aria-hidden="true" class="header-anchor">#</a> چند نکته</h2> <p>سعی کنید تا جای ممکن با دستورات CLI فندق آشنا بشید. این دستورات دوستان شما هستند و می‌توانند کمک زیادی به شما کنند.</p> <p>برای مثال با استفاده از این دستور در حین استقرار replica جدید می‌توانید اطلاعات ارزشمندی در مورد وضعیت replica هایتان به دست آورید.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ fandogh <span class="token function">service</span> details --name<span class="token operator">=</span>zero-downtime

Pods:
  Name: zero-downtime-7f9bd757-dh2gk
  Created at: 2018-09-08T11:06:34Z
  Phase: Running
  Ready containers: 1/1
  Containers:
    Name: zero-downtime
    Image: registry.fandogh.cloud/default/zero-downtime:v1.1
    Staus: Ready
    ---------------------
  Name: zero-downtime-7f9bd757-l2b5k
  Created at: 2018-09-08T11:06:52Z
  Phase: Running
  Ready containers: 1/1
  Containers:
    Name: zero-downtime
    Image: registry.fandogh.cloud/default/zero-downtime:v1.1
    Staus: Ready
    ---------------------
</code></pre></div><p>همینطور شما می‌توانید لاگ سرویس‌هایتان را به صورت آنی مشاهده کنید و نحوه رفتار سرویستان را مورد بررسی قرار دهید.</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ fandogh <span class="token function">service</span> logs --name<span class="token operator">=</span>zero-downtime -f
<span class="token punctuation">[</span>zero-downtime-7f9bd757-dh2gk<span class="token punctuation">]</span> <span class="token punctuation">[</span>zero-downtime<span class="token punctuation">]</span> -<span class="token operator">&gt;</span> Running on http://localhost:8080
<span class="token punctuation">[</span>zero-downtime-7f9bd757-l2b5k<span class="token punctuation">]</span> <span class="token punctuation">[</span>zero-downtime<span class="token punctuation">]</span> -<span class="token operator">&gt;</span> Running on http://localhost:8080

</code></pre></div><p>برای آشنایی بیشتر با دستورات فندق می‌توانید
<a href="https://docs.fandogh.cloud/docs/getting-started.html" target="_blank" rel="noopener noreferrer">مستندات فندق<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
را مطالعه کنید.</p></div></div></div></section> <footer class="footer-site" data-v-2887d02a><div class="footer-site-top" data-v-2887d02a><div class="footer-site-links" data-v-2887d02a><a href="/" class="footer-site-top-link" data-v-2887d02a>صفحه اصلی</a> <a href="https://blog.fandogh.cloud" class="footer-site-top-link" data-v-2887d02a>بلاگ</a> <a href="https://github.com/fandoghpaas" class="footer-site-top-link" data-v-2887d02a>Contribute</a></div> <div class="footer-site-top-social" data-v-2887d02a><a class="footer-site-top-social-item" data-v-2887d02a><img src="/assets/img/1.ddcd43be.svg" alt="Fandogh" data-v-2887d02a></a> <a href="https://github.com/fandoghpaas" class="footer-site-top-social-item" data-v-2887d02a><img src="/assets/img/2.86396a7d.svg" alt="Fandogh" data-v-2887d02a></a> <a href="https://twitter.com/fandoghpaas?s=09" class="footer-site-top-social-item" data-v-2887d02a><img src="/assets/img/3.c95aa774.svg" alt="Fandogh" data-v-2887d02a></a> <a href="support@fandogh.cloud" class="footer-site-top-social-item" data-v-2887d02a><img src="/assets/img/4.f058352a.svg" alt="Fandogh" data-v-2887d02a></a></div></div> <div class="footer-site-down" data-v-2887d02a><p data-v-2887d02a>
      کلیه حقوق این سایت متعلق به شرکت
      <a href="https://inb-co.com/" data-v-2887d02a>ایده‌نگاران‌بینا</a> می‌باشد
    </p></div></footer></div></div>
    <script src="/assets/js/app.3d705a25.js" defer></script><script src="/assets/js/11.41137f57.js" defer></script>
  </body>
</html>
